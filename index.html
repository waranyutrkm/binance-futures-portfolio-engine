<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Portfolio Engine (Quant)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        .modern-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .tab-btn.active { color: #f59e0b; border-bottom: 2px solid #f59e0b; background-color: #fffbeb; }
        .tab-btn { color: #64748b; padding: 8px 16px; transition: all 0.2s; border-radius: 8px 8px 0 0; }
        .tab-btn:hover { background-color: #f1f5f9; color: #334155; }

        /* Table Styling */
        .rebal-table th { background-color: #f1f5f9; color: #475569; font-weight: 600; font-size: 0.75rem; padding: 10px 8px; text-align: right; cursor: pointer; user-select: none; border-bottom: 2px solid #e2e8f0; }
        .rebal-table th:hover { background-color: #e2e8f0; color: #1e293b; }
        .rebal-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; font-size: 0.75rem; text-align: right; color: #334155; }
        .rebal-table tr:last-child td { border-bottom: none; }
        .rebal-table td:first-child, .rebal-table th:first-child { text-align: left; }
        
        .batch-row:hover { background-color: #f8fafc; cursor: pointer; }
        .batch-row.selected { background-color: #fffbeb; border-left: 4px solid #f59e0b; }

        .info-btn { 
            cursor: pointer; color: #94a3b8; font-size: 0.7rem; margin-left: 4px; vertical-align: middle;
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%; border: 1px solid #cbd5e1;
            transition: all 0.2s; background-color: #fff; font-weight: bold;
        }
        .info-btn:hover { color: #f59e0b; border-color: #f59e0b; background-color: #fffbeb; transform: scale(1.1); }

        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #f59e0b; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .th-tooltip { position: relative; }
        .th-tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 4px 8px;
            border-radius: 4px; font-size: 10px; white-space: nowrap; z-index: 50;
            margin-bottom: 4px; white-space: normal; width: 150px; text-align: center;
        }
        
        .pagination-btn {
            padding: 4px 10px; border: 1px solid #e2e8f0; border-radius: 4px; 
            font-size: 0.75rem; color: #64748b; background: white; cursor: pointer;
        }
        .pagination-btn:hover:not(:disabled) { background: #f1f5f9; color: #f59e0b; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .asset-tag { display: inline-flex; align-items: center; background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; color: #475569; }
        .asset-remove { margin-left: 6px; cursor: pointer; color: #ef4444; font-weight: bold; }
        .asset-remove:hover { color: #dc2626; }
        
        /* Inspector Modal specific */
        .status-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-warn { background: #fef9c3; color: #854d0e; }
        .status-err { background: #fee2e2; color: #991b1b; }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 text-slate-900 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-white">Binance Futures <span class="text-yellow-500">Portfolio Engine</span></h1>
                    <p class="text-xs text-slate-400">Pure FAPI Data ‚Ä¢ Multi-Asset ‚Ä¢ Batch Analysis</p>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <div class="hidden md:flex gap-2 bg-slate-800 p-1 rounded-lg">
                    <button onclick="switchTab('simulator')" id="tab-sim" class="tab-btn active text-xs font-bold">Quant Dashboard</button>
                    <button onclick="switchTab('history')" id="tab-hist" class="tab-btn text-xs font-bold">Allocation Log</button>
                    <button onclick="switchTab('docs')" id="tab-docs" class="tab-btn text-xs font-bold">Strategy Logic</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 space-y-8">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-simulator">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- LEFT PANEL: CONTROLS -->
                <div class="w-full lg:w-1/3 space-y-6">
                    
                    <!-- 1. Strategy Config -->
                    <div class="modern-card p-6 border-t-4 border-t-yellow-500">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">1. Portfolio Strategy</h3>
                                <span class="info-btn" onclick="showInfo('strategy_logic')">?</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Rebalance Logic</label>
                            <div class="relative">
                                <select id="strategy-select" onchange="updateStrategyDesc()" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-yellow-500 outline-none appearance-none font-medium text-slate-700">
                                    <optgroup label="üåü Batch Analysis">
                                        <option value="ALL">Run All Strategies (Compare All)</option>
                                    </optgroup>
                                    <optgroup label="Simple Weighting">
                                        <option value="Rank_All">Rank All (Weight by Rank)</option>
                                        <option value="Equal_Weight">Equal Weight (All Coins)</option>
                                    </optgroup>
                                    <optgroup label="Momentum / Top-K">
                                        <option value="Top3_Equal" selected>Top 3 Equal Weight (Leader)</option>
                                        <option value="Top3_Rank">Top 3 Weighted by Rank</option>
                                        <option value="Top50pct">Top 50% of Universe</option>
                                        <option value="AbsMom">Absolute Momentum (Long/Cash)</option>
                                        <option value="DualMom_Rel">Dual Momentum (Rel + Abs)</option>
                                    </optgroup>
                                    <optgroup label="Risk Based">
                                        <option value="InvVol">Inverse Volatility (Low Risk)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Description Box -->
                        <div id="strat-desc" class="bg-yellow-50 border border-yellow-100 p-3 rounded-lg text-xs text-yellow-800 leading-relaxed mb-4 min-h-[60px]">
                            <!-- JS will update this -->
                        </div>

                        <!-- Benchmark Selector -->
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Benchmark</label>
                            <select id="benchmark-select" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-yellow-500 outline-none">
                                <option value="BTCUSDT">Bitcoin (BTCUSDT)</option>
                                <option value="ETHUSDT">Ethereum (ETHUSDT)</option>
                                <option value="EQUAL_WEIGHT">Equal Weight Universe</option>
                                <option value="">None (Absolute)</option>
                            </select>
                        </div>

                        <!-- Asset Universe -->
                        <div class="mb-2 flex justify-between items-center">
                            <div class="flex items-center">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Crypto Universe</label>
                                <span class="info-btn" onclick="showInfo('universe')">?</span>
                            </div>
                            <button onclick="resetDefaultAssets()" class="text-[10px] text-yellow-600 hover:underline">Reset</button>
                        </div>
                        
                        <!-- Quick Add Dropdown -->
                        <div class="relative mb-2">
                            <select id="quick-add-asset" onchange="quickAddAsset(this.value)" class="w-full bg-white border border-dashed border-slate-300 rounded-lg text-xs py-2 px-3 text-slate-500 focus:border-yellow-500 outline-none cursor-pointer hover:bg-slate-50">
                                <option value="">+ Add Crypto Pair...</option>
                                <optgroup label="L1 / Majors">
                                    <option value="BTCUSDT">BTCUSDT</option>
                                    <option value="ETHUSDT">ETHUSDT</option>
                                    <option value="SOLUSDT">SOLUSDT</option>
                                    <option value="BNBUSDT">BNBUSDT</option>
                                    <option value="ADAUSDT">ADAUSDT</option>
                                    <option value="XRPUSDT">XRPUSDT</option>
                                    <option value="AVAXUSDT">AVAXUSDT</option>
                                </optgroup>
                                <optgroup label="Meme / Alt (Corrected Symbols)">
                                    <option value="DOGEUSDT">DOGEUSDT</option>
                                    <option value="1000SHIBUSDT">1000SHIBUSDT</option>
                                    <option value="1000PEPEUSDT">1000PEPEUSDT</option>
                                    <option value="LINKUSDT">LINKUSDT</option>
                                    <option value="DOTUSDT">DOTUSDT</option>
                                </optgroup>
                            </select>
                        </div>

                        <div id="asset-list" class="flex flex-wrap gap-2 mb-4 max-h-[150px] overflow-y-auto pr-1"></div>
                        
                        <!-- Manual Add Input -->
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="manual-ticker-input" placeholder="e.g. BTCUSDT" class="flex-1 bg-white border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-yellow-500 outline-none uppercase text-slate-700 font-bold" onkeypress="if(event.key==='Enter') addAssetManual()">
                            <button onclick="addAssetManual()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition-all shadow-sm">Add</button>
                        </div>
                    </div>

                    <!-- 2. Parameters -->
                    <div class="modern-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                2. Execution Parameters
                            </h3>
                            <span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-1 rounded-full font-bold">Multiple Values OK</span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Lookback (Days/Bars)</label>
                                    <span class="info-btn" onclick="showInfo('lookback')">?</span>
                                </div>
                                <input type="text" id="param-lookback" value="20, 60, 90" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 20, 60">
                                <p class="text-[9px] text-slate-400 mt-1">Comma separated for batch test (Daily timeframe)</p>
                            </div>
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Rebalance (Days)</label>
                                    <span class="info-btn" onclick="showInfo('rebalance')">?</span>
                                </div>
                                <input type="text" id="param-rebal" value="7, 14, 30" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 7, 30">
                            </div>
                        </div>

                        <!-- Leverage & Cost -->
                        <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100 grid grid-cols-2 gap-3">
                             <div>
                                <label class="text-[10px] text-slate-400 mb-1 flex items-center gap-1">Leverage (x)</label>
                                <input type="number" id="param-leverage" value="1" min="1" max="50" class="w-full bg-white border border-slate-200 rounded text-sm p-2 text-right text-slate-800 font-medium font-mono">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 mb-1 flex items-center gap-1">Fee+Slip (%)</label>
                                <input type="number" id="cost-tcost" value="0.06" step="0.01" class="w-full bg-white border border-slate-200 rounded text-sm p-2 text-right text-rose-600 font-medium font-mono">
                            </div>
                        </div>

                        <!-- Analysis Settings -->
                        <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">Rolling Analysis</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <div class="flex items-center mb-1">
                                        <label class="text-[9px] text-slate-400 block">Horizons (Years)</label>
                                    </div>
                                    <input type="text" id="param-horizons" value="1, 2, 3" class="w-full bg-white border border-slate-200 rounded text-xs p-1.5 text-slate-700 font-mono">
                                </div>
                                <div>
                                    <div class="flex items-center mb-1">
                                        <label class="text-[9px] text-slate-400 block">Step (Years)</label>
                                    </div>
                                    <input type="number" id="param-roll-step" value="0.2" step="0.1" class="w-full bg-white border border-slate-200 rounded text-xs p-1.5 text-slate-700 font-mono">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center mb-1.5">
                                <label class="text-[10px] font-bold text-slate-500 uppercase block">Backtest Range</label>
                            </div>
                            <div class="flex gap-2">
                                <input type="date" id="date-start" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                                <input type="date" id="date-end" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button id="btn-run" onclick="runBatchEngine()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                                    <span>Run Engine</span>
                                </button>
                                <button onclick="showDataInspector()" class="px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg shadow-sm flex items-center justify-center" title="Inspect Raw Data">
                                    üîç
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: VISUALIZATION -->
                <div class="w-full lg:w-2/3 space-y-6">
                    
                    <div id="results-container" class="hidden space-y-6">
                        
                        <!-- Batch Summary Table -->
                        <div class="modern-card p-6 border-l-4 border-yellow-500">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        Batch Comparison
                                        <span class="info-btn" onclick="showInfo('batch_comparison')">?</span>
                                    </h2>
                                    <p class="text-xs text-slate-500" id="table-info">Showing top results</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Best Sharpe Selected</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto mb-2">
                                <table class="w-full text-xs text-right rebal-table">
                                    <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="th-tooltip text-left" data-tip="Strategy Name" onclick="sortTable('strat')">Strat ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Lookback Period (Days)" onclick="sortTable('lb')">LB ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Rebalance Frequency (Days)" onclick="sortTable('rb')">RB ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Compound Annual Growth Rate" onclick="sortTable('cagr')">CAGR ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Risk-Adjusted Return" onclick="sortTable('sharpe')">Sharpe ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Maximum Drawdown" onclick="sortTable('mdd')">MaxDD ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Portfolio Turnover" onclick="sortTable('turnover')">TO ‚Üï</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batch-table-body" class="text-slate-700"></tbody>
                                </table>
                            </div>
                            <!-- Pagination Controls -->
                            <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                                <button id="btn-prev" onclick="changePage(-1)" class="pagination-btn">Previous</button>
                                <span id="page-indicator" class="text-xs text-slate-500">Page 1</span>
                                <button id="btn-next" onclick="changePage(1)" class="pagination-btn">Next</button>
                            </div>
                        </div>

                        <!-- Selected Result Details -->
                        <div id="single-result-view" class="space-y-6 animate-fade-in">
                            <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-lg mb-4 text-center">
                                <span class="text-xs font-bold text-indigo-500 uppercase">Selected Strategy</span>
                                <div id="res-strat-name" class="text-lg font-bold text-indigo-800">-</div>
                            </div>

                            <!-- Key Stats with Benchmark -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="modern-card p-4 border-l-4 border-emerald-500">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">CAGR (Annualized) <span class="info-btn" onclick="showInfo('cagr')">?</span></div>
                                    <div id="res-cagr" class="text-2xl font-bold text-emerald-600">-</div>
                                    <div id="bench-cagr" class="text-[10px] text-slate-400 mt-1">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Sharpe Ratio <span class="info-btn" onclick="showInfo('sharpe')">?</span></div>
                                    <div id="res-sharpe" class="text-2xl font-bold text-blue-600">-</div>
                                    <div id="bench-sharpe" class="text-[10px] text-slate-400 mt-1">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Max Drawdown <span class="info-btn" onclick="showInfo('mdd')">?</span></div>
                                    <div id="res-mdd" class="text-2xl font-bold text-rose-600">-</div>
                                    <div id="bench-mdd" class="text-[10px] text-slate-400 mt-1">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Turnover <span class="info-btn" onclick="showInfo('turnover')">?</span></div>
                                    <div id="res-turnover" class="text-2xl font-bold text-slate-600">-</div>
                                </div>
                            </div>

                            <!-- Main Equity Curve -->
                            <div class="modern-card p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        Growth Analysis
                                        <span class="info-btn" onclick="showInfo('growth_chart')">?</span>
                                    </h2>
                                    <div class="flex gap-4 text-xs">
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Strategy</span>
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-slate-400 rounded-full"></span> Benchmark</span>
                                    </div>
                                </div>
                                <div class="h-[300px]">
                                    <canvas id="chart-equity"></canvas>
                                </div>
                            </div>

                            <!-- INVESTOR ANALYSIS -->
                            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                                <div class="text-center mb-6">
                                    <h2 class="text-xl font-bold text-slate-800 flex items-center justify-center gap-2">
                                        Rolling Horizon Analysis
                                        <span class="info-btn" onclick="showInfo('rolling_chart')">?</span>
                                    </h2>
                                    <p class="text-sm text-slate-500">Historical performance stability check</p>
                                </div>
                                
                                <div class="modern-card p-6 mb-6">
                                    <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                        1. Return Range (Best - Worst Case)
                                        <span class="info-btn" onclick="showInfo('return_range')">?</span>
                                    </h3>
                                    <div class="h-[300px]">
                                        <canvas id="chart-range"></canvas>
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            2. Win Probability (>0%)
                                            <span class="info-btn" onclick="showInfo('win_prob')">?</span>
                                        </h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-loss"></canvas>
                                        </div>
                                    </div>
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            3. Average Annualized Return
                                            <span class="info-btn" onclick="showInfo('expected_ret')">?</span>
                                        </h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-expected"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div id="placeholder-viz" class="h-96 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <p class="text-sm font-medium">Configure parameters and Run Batch Analysis</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 2: ALLOCATION HISTORY -->
        <div id="view-history" class="hidden max-w-7xl mx-auto space-y-6">
             <div class="modern-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Rebalance History Log</h2>
                    <p class="text-xs text-slate-500">Showing log for selected strategy</p>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="w-full rebal-table" id="history-table">
                        <thead class="bg-slate-50">
                            <tr>
                                <th>Date</th>
                                <th>Portfolio Action</th>
                                <th>Turnover</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white" id="history-body">
                            <tr><td colspan="3" class="text-center py-4">Run the simulation to see history</td></tr>
                        </tbody>
                    </table>
                </div>
             </div>
        </div>

        <!-- VIEW 3: METHODOLOGY (Docs) -->
        <div id="view-docs" class="hidden max-w-4xl mx-auto my-8 space-y-8 animate-fade-in">
             <div class="p-6 bg-white border border-slate-200 rounded-xl">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Binance Futures Portfolio Engine Logic</h2>
                <div class="space-y-4 text-sm text-slate-600">
                    <p>This engine applies quantitative portfolio theory to the crypto futures market using <strong>Daily (1D)</strong> data for long-term backtesting.</p>
                    
                    <h3 class="font-bold text-slate-800">1. Data Source</h3>
                    <ul class="list-disc list-inside">
                        <li><strong>Source:</strong> Binance FAPI (Futures API).</li>
                        <li><strong>Interval:</strong> Daily (1d). This ensures ability to backtest 3-5 years without hitting browser memory limits.</li>
                        <li><strong>Filling:</strong> Missing data is filled forward.</li>
                    </ul>

                    <h3 class="font-bold text-slate-800">2. Portfolio Strategies</h3>
                    <ul class="list-disc list-inside">
                        <li><strong>Top 3 Equal:</strong> Selects the 3 best performing assets over the Lookback period and allocates 33% to each.</li>
                        <li><strong>Rank All:</strong> Allocates to all assets, weighted by their momentum rank (higher momentum = higher weight).</li>
                        <li><strong>Dual Momentum:</strong> Only invests if asset is in uptrend (Absolute > 0) AND performing better than peers (Relative).</li>
                    </ul>

                    <h3 class="font-bold text-slate-800">3. Leverage & Cost</h3>
                    <ul class="list-disc list-inside">
                        <li><strong>Leverage:</strong> Applied to daily returns. Effect = (Return * Leverage).</li>
                        <li><strong>Cost:</strong> Fee + Slippage is applied to the <em>Turnover</em> amount on rebalance days.</li>
                    </ul>
                </div>
             </div>
        </div>

    </main>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4" onclick="if(event.target===this) closeInfo()">
        <div class="bg-white p-6 max-w-md w-full rounded-2xl shadow-xl transform transition-all scale-100">
            <h3 id="info-title" class="text-lg font-bold text-blue-700 mb-3 border-b pb-2">Title</h3>
            <div id="info-desc" class="text-sm text-slate-600 leading-relaxed mb-6 font-light">Description</div>
            <button onclick="closeInfo()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition-colors">Close</button>
        </div>
    </div>

    <!-- Data Inspector Modal -->
    <div id="inspector-modal" class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4" onclick="if(event.target===this) closeInspector()">
        <div class="bg-white p-6 max-w-2xl w-full rounded-2xl shadow-xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    üîç Data Inspector
                </h3>
                <button onclick="closeInspector()" class="text-slate-400 hover:text-slate-600 font-bold text-xl">√ó</button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-xs text-right border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Asset</th>
                            <th class="p-2">Count</th>
                            <th class="p-2">Start Price</th>
                            <th class="p-2">End Price</th>
                            <th class="p-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="inspector-body" class="text-slate-700">
                        <tr><td colspan="5" class="p-4 text-center">No data loaded. Run backtest first.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 pt-2 border-t text-xs text-slate-400">
                Tip: Status <span class="text-rose-600">RED</span> means error.
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center">
        <div class="loader mb-4 border-t-yellow-500"></div>
        <div class="text-lg font-bold text-slate-700">Crunching Data...</div>
        <div id="loading-status" class="text-sm text-slate-500 mt-2">Connecting to Binance...</div>
    </div>

<script>
    // --- CONFIG & STATE ---
    const DEFAULT_ASSETS = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT", "XRPUSDT", "ADAUSDT"];
    let STATE = {
        assets: [...DEFAULT_ASSETS],
        batchResults: [],
        selectedResultIndex: 0,
        benchmarkData: null,
        benchmarkStats: null,
        currentPage: 1,
        rowsPerPage: 20, 
        sortCol: 'sharpe',
        sortAsc: false,
        dataInspectionReport: []
    };
    let charts = {};

    // --- TEXTS ---
    const STRAT_DESCS = {
        "ALL": "Run every strategy below and compare results in the Batch Table.",
        "Rank_All": "Weight all assets based on momentum rank. (Rank 1 gets highest weight).",
        "Equal_Weight": "Equal allocation to all assets in the universe (1/N).",
        "Top3_Equal": "Select top 3 assets by momentum. Allocate 33.3% to each.",
        "Top3_Rank": "Select top 3 assets. Weight them by rank (e.g. 50%, 33%, 17%).",
        "Top50pct": "Select top 50% of the universe. Equal weight.",
        "AbsMom": "Only hold assets with positive trend (Price > Lookback Price). Otherwise Cash.",
        "DualMom_Rel": "Must be positive trend AND in top 50% relative strength.",
        "InvVol": "Inverse Volatility: Low volatility assets get higher weight."
    };
    const STRAT_SHORT_NAMES = {
        "Rank_All": "Rank All", "Equal_Weight": "Eq Wgt", "Top3_Equal": "Top3 Eq", 
        "Top3_Rank": "Top3 Rnk", "Top50pct": "Top 50%", "AbsMom": "Abs Mom", 
        "DualMom_Rel": "Dual Mom", "InvVol": "Inv Vol"
    };
    const INFO_TEXTS = {
        "strategy_logic": "<b>Strategy Logic</b> defines how the portfolio is rebalanced each period.",
        "universe": "<b>Crypto Universe</b>: The basket of Futures Contracts to select from.",
        "lookback": "<b>Lookback (Days)</b>: Historical window to calculate Momentum/Volatility.",
        "rebalance": "<b>Rebalance (Days)</b>: How often to adjust the portfolio weights.",
        "cagr": "<b>CAGR</b>: Compound Annual Growth Rate (with Leverage applied).",
        "sharpe": "<b>Sharpe Ratio</b>: Excess return per unit of risk.",
        "mdd": "<b>Max Drawdown</b>: Deepest peak-to-valley decline.",
        "turnover": "<b>Turnover</b>: Annualized portfolio churn (0-200%). Higher = more fees.",
        "growth_chart": "Log-scale equity curve vs Benchmark.",
        "rolling_chart": "Simulate starting on random dates in the past to test robustness.",
        "return_range": "Best and Worst case annualized returns for different holding periods.",
        "win_prob": "Probability of making profit (>0%) for a given holding period.",
        "expected_ret": "Average annualized return for a given holding period."
    };

    // --- UI HELPERS ---
    function updateStrategyDesc() { document.getElementById('strat-desc').innerText = STRAT_DESCS[document.getElementById('strategy-select').value] || ""; }
    function showInfo(k) { 
        document.getElementById('info-title').innerText = k.replace('_',' ').toUpperCase();
        document.getElementById('info-desc').innerHTML = INFO_TEXTS[k] || "No desc";
        document.getElementById('info-modal').classList.remove('hidden'); document.getElementById('info-modal').classList.add('flex');
    }
    function closeInfo() { document.getElementById('info-modal').classList.add('hidden'); document.getElementById('info-modal').classList.remove('flex'); }
    function getVal(id) { const el=document.getElementById(id); return el?el.value:""; }
    function switchTab(t) { 
        ['simulator','history','docs'].forEach(v=>document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${t}`).classList.remove('hidden');
        ['sim','hist','docs'].forEach(v=>document.getElementById(`tab-${v}`).classList.remove('active'));
        document.getElementById(`tab-${t==='simulator'?'sim':t==='history'?'hist':'docs'}`).classList.add('active');
    }
    function showEl(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
    function hideEl(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }
    
    // --- INSPECTOR HELPERS ---
    function showDataInspector() {
        const modal = document.getElementById('inspector-modal');
        const tbody = document.getElementById('inspector-body');
        modal.classList.remove('hidden'); modal.classList.add('flex');
        
        tbody.innerHTML = '';
        if(!STATE.dataInspectionReport || STATE.dataInspectionReport.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No data loaded yet.</td></tr>';
            return;
        }
        
        STATE.dataInspectionReport.forEach(r => {
            let statusClass = 'status-ok';
            if(r.status.includes('ERR')) statusClass = 'status-err';
            else if(r.status.includes('WARN')) statusClass = 'status-warn';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-2 text-left font-bold border-b border-slate-100">${r.asset}</td>
                <td class="p-2 border-b border-slate-100">${r.count}</td>
                <td class="p-2 border-b border-slate-100">${r.startP}</td>
                <td class="p-2 border-b border-slate-100">${r.endP}</td>
                <td class="p-2 border-b border-slate-100"><span class="status-badge ${statusClass}">${r.status}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }
    function closeInspector() { document.getElementById('inspector-modal').classList.add('hidden'); document.getElementById('inspector-modal').classList.remove('flex'); }

    // --- ASSET MANAGEMENT ---
    function renderAssetList() {
        const c = document.getElementById('asset-list'); c.innerHTML='';
        STATE.assets.forEach(a => {
            c.innerHTML += `<span class="asset-tag">${a} <span class="asset-remove" onclick="removeAsset('${a}')">√ó</span></span>`;
        });
    }
    function addAssetManual() {
        const v = document.getElementById('manual-ticker-input').value.trim().toUpperCase();
        if(v && !STATE.assets.includes(v)) { STATE.assets.push(v); renderAssetList(); }
        document.getElementById('manual-ticker-input').value = '';
    }
    function quickAddAsset(v) { if(v && !STATE.assets.includes(v)) { STATE.assets.push(v); renderAssetList(); } document.getElementById('quick-add-asset').value = ""; }
    function removeAsset(v) { STATE.assets = STATE.assets.filter(a=>a!==v); renderAssetList(); }
    function resetDefaultAssets() { STATE.assets = [...DEFAULT_ASSETS]; renderAssetList(); }

    // --- BINANCE DATA ENGINE ---
    async function fetchBinanceData(symbol, start, end) {
        let startTime = new Date(start).getTime();
        const endTime = new Date(end).getTime();
        
        if (isNaN(startTime) || isNaN(endTime)) return []; // Guard
        if (startTime >= endTime) return [];

        let allKlines = [];
        const interval = '1d'; 

        try {
            while (startTime < endTime) {
                const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}&limit=1500`;
                const res = await fetch(url);
                if (!res.ok) {
                    console.warn(`Binance fetch failed for ${symbol}: ${res.status}`);
                    return []; // Return empty instead of throw to keep Promise.all alive
                }
                const data = await res.json();
                
                if (!Array.isArray(data) || data.length === 0) break;

                data.forEach(k => {
                    allKlines.push({
                        date: new Date(k[0]).toISOString().split('T')[0],
                        price: parseFloat(k[4]) // Close Price
                    });
                });
                
                startTime = data[data.length - 1][0] + 1;
                // Rate limit guard
                await new Promise(r => setTimeout(r, 50));
            }
            allKlines._source = "BINANCE_FAPI";
            return allKlines;
        } catch (err) {
            console.error(err);
            return []; // Return empty on fail
        }
    }

    // --- CORE MATH ---
    function calcReturns(p, lb) {
        const r=new Array(p.length).fill(NaN);
        for(let i=lb; i<p.length; i++) {
            const prev = p[i-lb];
            if(prev && prev !== 0) r[i] = (p[i]/prev) - 1;
            else r[i] = 0;
        }
        return r;
    }
    function calcVol(dr, lb) {
        const r=new Array(dr.length).fill(NaN);
        for(let i=lb; i<dr.length; i++) {
            const w=dr.slice(i-lb+1, i+1);
            if(w.length < 2) { r[i] = 0; continue; }
            const m=w.reduce((a,b)=>a+b,0)/w.length;
            r[i] = Math.sqrt(w.reduce((a,b)=>a+Math.pow(b-m,2),0)/(w.length-1));
        }
        return r;
    }
    function getWeights(strat, sig, vol, keys) {
        const active = keys.filter(k=>!isNaN(sig[k]));
        if(!active.length) return {};
        
        const items = active.map(k=>({k, val:sig[k], vol:vol[k] || 0}));
        items.sort((a,b)=>b.val-a.val); // Sort Desc by Signal (Momentum)
        
        let w={}; keys.forEach(k=>w[k]=0);
        
        if(strat==="Rank_All") { 
            const N=items.length, S=(N*(N+1))/2; 
            items.forEach((x,i)=>w[x.k]=(N-i)/S); 
        }
        else if(strat==="Equal_Weight") { 
            items.forEach(x=>w[x.k]=1/items.length); 
        }
        else if(strat==="Top3_Equal") { 
            const K=Math.min(3,items.length); 
            for(let i=0;i<K;i++) w[items[i].k]=1/K; 
        }
        else if(strat==="Top3_Rank") { 
            const K=Math.min(3,items.length), S=(K*(K+1))/2; 
            for(let i=0;i<K;i++) w[items[i].k]=(K-i)/S; 
        }
        else if(strat==="Top50pct") { 
            const K=Math.max(1,Math.floor(items.length/2)); 
            for(let i=0;i<K;i++) w[items[i].k]=1/K; 
        }
        else if(strat==="AbsMom") { 
            const p=items.filter(x=>x.val>0); 
            if(p.length) p.forEach(x=>w[x.k]=1/p.length); 
        }
        else if(strat==="DualMom_Rel") { 
            const p=items.filter(x=>x.val>0), K=Math.max(1,Math.floor(p.length/2)); 
            if(p.length) for(let i=0;i<K;i++) w[p[i].k]=1/K; 
        }
        else if(strat==="InvVol") { 
            let S=0; 
            items.forEach(x=>{ if(x.vol>0) S+=1/x.vol; }); 
            if(S>0) items.forEach(x=>{ if(x.vol>0) w[x.k]=(1/x.vol)/S; });
            else items.forEach(x=>w[x.k]=1/items.length); 
        }
        return w;
    }

    function calcStats(c) {
        if (!c || c.length < 2) return { cagr: "0.00", sharpe: "0.00", mdd: "0.00" };
        const r = [];
        for (let i = 1; i < c.length; i++) r.push(c[i] / c[i - 1] - 1);

        const cagr = (Math.pow(c[c.length - 1] / c[0], 252 / c.length) - 1) * 100;
        const mean = r.reduce((a, b) => a + b, 0) / r.length;
        const std = Math.sqrt(r.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (r.length - 1));
        const sharpe = std > 0 ? (mean / std) * Math.sqrt(252) : 0; 

        let peak = -Infinity;
        let mdd = 0;
        for (let v of c) {
            if (v > peak) peak = v;
            const dd = (v - peak) / peak;
            if (dd < mdd) mdd = dd;
        }

        return {
            cagr: cagr.toFixed(2),
            sharpe: sharpe.toFixed(2),
            mdd: (mdd * 100).toFixed(2)
        };
    }

    // --- MAIN ENGINE ---
    async function runBatchEngine() {
        const btn=document.getElementById('btn-run');
        const over=document.getElementById('loading-overlay'), status=document.getElementById('loading-status');
        
        if(btn) btn.disabled=true; 
        if(over) { over.classList.remove('hidden'); over.classList.add('flex'); }
        
        STATE.batchResults=[];

        try {
            const start=getVal('date-start'), end=getVal('date-end');
            const lbs=getVal('param-lookback').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const rbs=getVal('param-rebal').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const leverage = parseFloat(getVal('param-leverage')) || 1;
            const tcost=parseFloat(getVal('cost-tcost'))/100;
            const selectedStrat=document.getElementById('strategy-select').value;
            const benchSym=document.getElementById('benchmark-select').value;
            const horizons = getVal('param-horizons').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const rollStepYears = parseFloat(getVal('param-roll-step')) || 0.1;
            const rollStep = Math.max(1, Math.floor(rollStepYears * 252));

            // Determine Strategy List (NEW LOGIC)
            let stratList = [selectedStrat];
            let isRunAll = (selectedStrat === 'ALL');
            
            if (isRunAll) {
                // Get all options from select except ALL
                const options = document.querySelectorAll('#strategy-select option');
                stratList = Array.from(options).map(o => o.value).filter(v => v && v !== 'ALL'); 
            }

            // 1. Fetch Data (Common)
            status.innerText = `Fetching ${STATE.assets.length} crypto pairs from Binance...`;
            const raw = await Promise.all(STATE.assets.map(s=>fetchBinanceData(s, start, end)));
            
            // 2. Data Inspection & Alignment
            const report = [];
            STATE.assets.forEach((a, i) => {
                const d = raw[i];
                let s = "OK";
                if(!d || d.length===0) s = "ERR: No Data";
                report.push({ asset:a, count:d?d.length:0, startP:d?.[0]?.price||0, endP:d?.[d.length-1]?.price||0, status:s });
            });
            STATE.dataInspectionReport = report;

            let dates = raw[0] && raw[0].length ? raw[0].map(d=>d.date) : [];
            const prices = [];
            
            if(dates.length > 0) {
                dates.forEach(d => {
                    let row={date:d}; 
                    STATE.assets.forEach((s,i)=>{ 
                        const f=raw[i].find(x=>x.date===d); 
                        if(f) row[s]=f.price; 
                    });
                    STATE.assets.forEach(s => {
                       if(!row[s] && prices.length>0) row[s] = prices[prices.length-1][s];
                    });
                    if(STATE.assets.every(k=>row[k]!==undefined)) prices.push(row);
                });
                dates = prices.map(p=>p.date);
            }

            // 3. Benchmark Data
            STATE.benchmarkData = null;
            if(benchSym && benchSym!=="EQUAL_WEIGHT") {
                status.innerText = "Fetching Benchmark...";
                const bRaw = await fetchBinanceData(benchSym, start, end);
                STATE.benchmarkData = dates.map(d=> {
                    const f = bRaw.find(x=>x.date===d);
                    return f ? f.price : (bRaw[bRaw.length-1]?.price || 100);
                });
            }

            // 4. Pre-Calc Indicators (Common across strategies)
            if(prices.length > 0) {
                status.innerText="Calculating Common Indicators...";
                const daily={}, vols={}, sigs={};
                STATE.assets.forEach(s => {
                    const p = prices.map(r=>r[s]);
                    daily[s] = new Array(p.length).fill(0);
                    for(let i=1;i<p.length;i++) {
                        const prev = p[i-1];
                        daily[s][i] = (prev && prev !== 0) ? (p[i]/prev - 1) : 0;
                    }
                    vols[s] = calcVol(daily[s], 20); 
                });
                
                lbs.forEach(lb => {
                    sigs[lb]={}; 
                    STATE.assets.forEach(s => sigs[lb][s] = calcReturns(prices.map(r=>r[s]), lb));
                });

                // 5. Strategy Loop
                let totalSims = stratList.length * lbs.length * rbs.length;
                let currentSim = 0;

                for (let strat of stratList) {
                    status.innerText = `Simulating ${STRAT_SHORT_NAMES[strat] || strat}...`;
                    
                    for(let lb of lbs) {
                        for(let rb of rbs) {
                            currentSim++;
                            
                            let va=1000, ca=[1000], w={}, totTO=0, log=[];
                            STATE.assets.forEach(k=>w[k]=0);
                            
                            const startIdx = Math.max(lb, 20); 
                            if(startIdx >= prices.length) continue;

                            for(let t=startIdx; t<prices.length; t++) {
                                // Return
                                let dr=0; 
                                STATE.assets.forEach(k=>dr+=w[k]*(daily[k][t]||0));
                                if(isNaN(dr)) dr=0;
                                
                                // Leverage
                                const levDr = dr * leverage;
                                va *= (1 + levDr);
                                if(va < 0) va = 0; 

                                // Rebalance
                                if((t-startIdx) % rb === 0) {
                                    const sT={}, vT={}; 
                                    STATE.assets.forEach(k=>{ sT[k]=sigs[lb][k][t]||0; vT[k]=vols[k][t]||0; });
                                    
                                    const tw = getWeights(strat, sT, vT, STATE.assets);
                                    
                                    let to=0; 
                                    STATE.assets.forEach(k=>to+=Math.abs((tw[k]||0)-(w[k]||0)));
                                    
                                    const costAmt = to * tcost; 
                                    va *= (1 - costAmt);

                                    totTO += to; 
                                    w = tw;
                                    
                                    if(t % (rb*2) === 0 && !isRunAll) { // Log sparingly (only for single run mode mainly)
                                        const activeHoldings = Object.entries(w).filter(([k,v])=>v>0.01).map(([k,v])=>`${k}:${Math.round(v*100)}%`).join(', ');
                                        log.push({ date: dates[t], action: activeHoldings || "Cash", turnover: (to*100).toFixed(1)+"%" });
                                    }
                                }
                                ca.push(va);
                            }
                            
                            const stats = calcStats(ca);
                            const years = (prices.length - startIdx) / 252;
                            const annTO = years > 0 ? ((totTO / 2) / years) * 100 : 0;
                            
                            // Bench
                            let benchCurve = null;
                            if(STATE.benchmarkData) {
                                const base = STATE.benchmarkData[startIdx] || 1;
                                benchCurve = STATE.benchmarkData.slice(startIdx).map(v => (v/base)*1000);
                            } else if (benchSym === "EQUAL_WEIGHT") {
                                let bc = [1000], bv=1000;
                                for(let t=startIdx; t<prices.length; t++) {
                                    let dr=0; STATE.assets.forEach(k=>dr+=(1/STATE.assets.length)*(daily[k][t]||0));
                                    bv *= (1+dr); bc.push(bv);
                                }
                                benchCurve = bc;
                            }

                            STATE.batchResults.push({ 
                                config:{ strat, stratName: STRAT_SHORT_NAMES[strat] || strat, lb, rb }, 
                                curve:ca, 
                                dates: dates.slice(startIdx), 
                                stats, 
                                annTO: annTO.toFixed(0), 
                                log, 
                                benchCurve,
                                benchStats: calcStats(benchCurve),
                                rollSettings: { horizons, rollStep }
                            });
                        }
                    }
                }
            } else {
                alert("No valid data fetched. Check inspector.");
            }
            
            STATE.batchResults.sort((a,b)=>parseFloat(b.stats.sharpe)-parseFloat(a.stats.sharpe));
            renderBatchTable();
            if(STATE.batchResults.length > 0) viewResult(0);
            
            showEl('results-container');
            hideEl('placeholder-viz');

        } catch(e) { 
            console.error(e);
            alert("Error: " + e.message); 
        } finally { 
            if(btn) btn.disabled=false; 
            if(over) { over.classList.add('hidden'); over.classList.remove('flex'); } 
        }
    }

    // --- VISUALIZATION & TABLES ---
    function renderBatchTable() {
        const tbody = document.getElementById('batch-table-body');
        tbody.innerHTML = '';
        
        const start = (STATE.currentPage - 1) * STATE.rowsPerPage;
        const end = start + STATE.rowsPerPage;
        const subset = STATE.batchResults.slice(start, end);
        
        document.getElementById('page-indicator').innerText = `Page ${STATE.currentPage}`;
        document.getElementById('btn-prev').disabled = STATE.currentPage === 1;
        document.getElementById('btn-next').disabled = end >= STATE.batchResults.length;

        subset.forEach((r, i) => {
            const globalIdx = start + i;
            const tr = document.createElement('tr');
            tr.className = `batch-row transition-all ${globalIdx===STATE.selectedResultIndex ? 'selected' : ''}`;
            tr.onclick = () => viewResult(globalIdx);
            
            // Strat Name Pill Color
            let stratColor = "text-slate-500";
            if(r.config.strat.includes("Top3")) stratColor = "text-indigo-600 font-bold";
            if(r.config.strat.includes("Dual")) stratColor = "text-purple-600 font-bold";

            tr.innerHTML = `
                <td class="text-left ${stratColor}">${r.config.stratName}</td>
                <td class="font-mono text-slate-500">${r.config.lb}</td>
                <td class="font-mono text-slate-500">${r.config.rb}</td>
                <td class="font-bold ${parseFloat(r.stats.cagr)>0?'text-emerald-600':'text-rose-600'}">${r.stats.cagr}%</td>
                <td class="font-bold text-blue-600">${r.stats.sharpe}</td>
                <td class="text-rose-600">${r.stats.mdd}%</td>
                <td class="text-slate-500">${r.annTO}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sortTable(col) {
        if(STATE.sortCol === col) STATE.sortAsc = !STATE.sortAsc;
        else { STATE.sortCol = col; STATE.sortAsc = false; }
        
        STATE.batchResults.sort((a,b) => {
            let vA, vB;
            if(col==='lb') { vA=a.config.lb; vB=b.config.lb; }
            else if(col==='rb') { vA=a.config.rb; vB=b.config.rb; }
            else if(col==='turnover') { vA=parseFloat(a.annTO); vB=parseFloat(b.annTO); }
            else if(col==='strat') { vA=a.config.stratName; vB=b.config.stratName; return STATE.sortAsc ? vA.localeCompare(vB) : vB.localeCompare(vA); }
            else { vA=parseFloat(a.stats[col]); vB=parseFloat(b.stats[col]); }
            return STATE.sortAsc ? vA-vB : vB-vA;
        });
        renderBatchTable();
    }
    
    function changePage(d) {
        STATE.currentPage += d;
        renderBatchTable();
    }

    function viewResult(idx) {
        STATE.selectedResultIndex = idx;
        const res = STATE.batchResults[idx];
        
        const rows = document.querySelectorAll('.batch-row');
        rows.forEach(r => r.classList.remove('selected'));
        renderBatchTable();

        document.getElementById('res-strat-name').innerText = res.config.stratName;
        document.getElementById('res-cagr').innerText = res.stats.cagr + "%";
        document.getElementById('res-sharpe').innerText = res.stats.sharpe;
        document.getElementById('res-mdd').innerText = res.stats.mdd + "%";
        document.getElementById('res-turnover').innerText = res.annTO + "%";

        if(res.benchStats) {
            document.getElementById('bench-cagr').innerText = `Bench: ${res.benchStats.cagr}%`;
            document.getElementById('bench-sharpe').innerText = `Bench: ${res.benchStats.sharpe}`;
            document.getElementById('bench-mdd').innerText = `Bench: ${res.benchStats.mdd}%`;
        }

        renderEquityChart(res);
        renderRollingCharts(res);

        const hBody = document.getElementById('history-body');
        hBody.innerHTML = '';
        if(res.log.length > 0) {
            res.log.slice().reverse().forEach(l => {
                hBody.innerHTML += `<tr><td>${l.date}</td><td>${l.action}</td><td>${l.turnover}</td></tr>`;
            });
        } else {
             hBody.innerHTML += `<tr><td colspan="3" class="text-center py-4">Logs disabled for "Run All" (Too large)</td></tr>`;
        }
    }

    // --- CHART RENDERING ---
    function destroyChart(id) { if(charts[id]) { charts[id].destroy(); charts[id]=null; } }

    function renderEquityChart(res) {
        destroyChart('chart-equity');
        const ctx = document.getElementById('chart-equity').getContext('2d');
        
        const datasets = [{
            label: res.config.stratName,
            data: res.curve,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true
        }];

        if(res.benchCurve) {
            datasets.push({
                label: 'Benchmark',
                data: res.benchCurve,
                borderColor: '#94a3b8',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            });
        }

        charts['chart-equity'] = new Chart(ctx, {
            type: 'line',
            data: { labels: res.dates, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { 
                    y: { type: 'logarithmic', display: true, grid: { color: '#f1f5f9' } }, 
                    x: { display: false } 
                },
                plugins: { legend: { display: true } }
            }
        });
    }

    function renderRollingCharts(res) {
        const curve = res.curve;
        const benchCurve = res.benchCurve;
        const horizons = res.rollSettings.horizons;
        const step = res.rollSettings.rollStep;
        
        const ranges = { labels: [], min: [], max: [], avg: [] };
        const winProbs = { labels: [], strat: [], bench: [] };
        const expected = { labels: [], strat: [], bench: [] };

        horizons.forEach(yr => {
            const days = yr * 252;
            const rets = [];
            const benchRets = [];
            
            for(let i=0; i < curve.length - days; i += step) {
                const annRet = (Math.pow(curve[i+days]/curve[i], 1/yr) - 1) * 100;
                rets.push(annRet);
                if(benchCurve) {
                    const bAnnRet = (Math.pow(benchCurve[i+days]/benchCurve[i], 1/yr) - 1) * 100;
                    benchRets.push(bAnnRet);
                }
            }

            if(rets.length > 0) {
                ranges.labels.push(`${yr}Y`);
                ranges.min.push(Math.min(...rets));
                ranges.max.push(Math.max(...rets));
                ranges.avg.push(rets.reduce((a,b)=>a+b,0)/rets.length);
                
                winProbs.labels.push(`${yr}Y`);
                winProbs.strat.push((rets.filter(x=>x>0).length/rets.length)*100);
                winProbs.bench.push(benchRets.length ? (benchRets.filter(x=>x>0).length/benchRets.length)*100 : 0);

                expected.labels.push(`${yr}Y`);
                expected.strat.push(rets.reduce((a,b)=>a+b,0)/rets.length);
                expected.bench.push(benchRets.length ? benchRets.reduce((a,b)=>a+b,0)/benchRets.length : 0);
            }
        });

        destroyChart('chart-range');
        charts['chart-range'] = new Chart(document.getElementById('chart-range'), {
            type: 'bar',
            data: {
                labels: ranges.labels,
                datasets: [
                    { label: 'Max', data: ranges.max, backgroundColor: '#60a5fa', order: 2 }, 
                    { label: 'Avg', data: ranges.avg, type: 'line', borderColor: '#1e40af', order: 0 },
                    { label: 'Min', data: ranges.min, backgroundColor: '#f43f5e', order: 3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        destroyChart('chart-loss');
        charts['chart-loss'] = new Chart(document.getElementById('chart-loss'), {
            type: 'bar',
            data: {
                labels: winProbs.labels,
                datasets: [
                    { label: 'Strategy Win %', data: winProbs.strat, backgroundColor: '#10b981' },
                    { label: 'Bench Win %', data: winProbs.bench, backgroundColor: '#94a3b8' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
        });

        destroyChart('chart-expected');
        charts['chart-expected'] = new Chart(document.getElementById('chart-expected'), {
            type: 'bar',
            data: {
                labels: expected.labels,
                datasets: [
                    { label: 'Strategy Avg %', data: expected.strat, backgroundColor: '#6366f1' },
                    { label: 'Bench Avg %', data: expected.bench, backgroundColor: '#94a3b8' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- INIT ---
    window.onload = () => {
        const today = new Date();
        document.getElementById('date-end').value = today.toISOString().split('T')[0];
        const start = new Date(); start.setFullYear(today.getFullYear() - 2); 
        document.getElementById('date-start').value = start.toISOString().split('T')[0];
        
        renderAssetList();
        updateStrategyDesc();
    };
</script>
</body>
</html>
